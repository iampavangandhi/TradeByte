<main class="md:col-span-4 md:ml-56 lg:ml-64 md:pr-14 w-full">
    <div class="container px-5 py-10 mx-auto md:px-auto">
        <!-- <div class="absolute-center mx-auto"> -->

        <!-- header -->

        <header class="my-4 absolute-center">
            <span class="text-gray-700 text-3xl font-semibold leading-none tracking-wider">Hello,</span>
            <h2 class="text-5xl leading-none tracking-wider view-link">
                <%= user.displayName%>.
            </h2>
        </header>

        <hr class="line" />

        <!-- search box -->

        <div>
            <div class="bg-white relative text-gray-800 mt-12 shadow-md rounded-lg">
                <input id="searchbar" type="search" name="serch" placeholder="Search Stocks"
                    class="bg-transparent h-10 px-5 pl-10 block w-full rounded-full text-lg focus:outline-none" />
                <button type="submit" class="absolute left-0 top-0 mt-3 ml-4">
                    <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px"
                        viewBox="0 0 56.966 56.966" style="enable-background: new 0 0 56.966 56.966"
                        xml:space="preserve" width="512px" height="512px">
                        <path
                            d="M55.146,51.887L41.588,37.786c3.486-4.144,5.396-9.358,5.396-14.786c0-12.682-10.318-23-23-23s-23,10.318-23,23  s10.318,23,23,23c4.761,0,9.298-1.436,13.177-4.162l13.661,14.208c0.571,0.593,1.339,0.92,2.162,0.92  c0.779,0,1.518-0.297,2.079-0.837C56.255,54.982,56.293,53.08,55.146,51.887z M23.984,6c9.374,0,17,7.626,17,17s-7.626,17-17,17  s-17-7.626-17-17S14.61,6,23.984,6z" />
                    </svg>
                </button>
            </div>

            <ul id="search-result" style="height: 0px; overflow: hidden; white-space: pre"
                class="text-lg p-5 ml-10 list-none mt-0 text-gray-700"></ul>

            <div class="mt-4 grid lg:grid-cols-3 gap-10">
                <!-- cards go here -->

                <!-- card1 -->

                <div class="card bg-white rounded-lg flex items-center h-20 sm:h-20 w-full object-cover px-5 shadow-2xl">
                    <div class="flex-shrink-0 w-10 h-10">
                        <img class="w-full h-full" src="images/graph1.png" alt=" " />
                    </div>
                    <div class="font-bold text-xl xl:text-2xl ml-3">
                        <p class="text-gray-900 whitespace-no-wrap">$40,342.04</p>
                        <span class="block text-gray-500 text-sm">Total Portfolio</span>
                    </div>
                </div>

                <!-- card 2 -->

                <div class="card bg-white rounded-lg flex items-center h-20 sm:h-20 w-full object-cover px-5 shadow-2xl">
                    <div class="flex-shrink-0 w-10 h-10">
                        <img class="w-full h-full" src="images/graph2.png" alt=" " />
                    </div>
                    <div class="font-bold text-xl xl:text-2xl ml-3 justify-center">
                        <p class="text-gray-900 whitespace-no-wrap">$ 40,342.04</p>
                        <span class="block text-gray-500 text-sm">Profit / Loss</span>
                    </div>
                </div>

                <!-- card 3 -->

                <div class="card bg-white rounded-lg flex items-center h-20 sm:h-20 w-full object-cover px-5 shadow-2xl">
                    <div class="flex-shrink-0 w-10 h-10">
                        <img class="w-full h-full" src="images/graph3.png" alt=" " />
                    </div>
                    <div class="font-bold text-xl xl:text-2xl ml-3">
                        <p class="text-gray-900 whitespace-no-wrap">$ <%= user.balance%></p>
                        <span class="block text-gray-500 text-sm">Balance</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock status table -->
        <div class="mt-12">
            <div class="flex justify-between">
                <!-- heading of table -->
                <h2 class="text-lg font-bold leading-tight py-3">Your Stock Status</h2>
                <a href="#" class="mt-3 font-bold text-tempc-400">View All <span class="font-extrabold">></span></a>
            </div>
            <% if(  StockMessage === '') { %>
            <table class="table-fixed w-full">
                <thead>
                  <tr class="bg-gray-100 font-semibold text-gray-600 text-xs uppercase border-b tracking-wider">
                    <th class="w-1/3 px-4 py-2">Symbol</th>
                    <th class="w-1/3 px-4 py-2">amount</th>
                    <th class="w-1/3 px-4 py-2">current</th>
                    <th class="w-1/3 px-4 py-2">status</th>
                    <th class="w-1/3 px-4 py-2">Number of Stock</th>
                    <th class="w-1/5 px-4 py-2">Sell</th>
                  </tr>
                </thead>
                <tbody>
                  <% user.stock.forEach( (stock) => { %>
                  <tr class="bg-white border-b">
                    <td class=" px-4 py-2 text-center">
                        <%= stock.companySymbol %>
                    </td>
                    <td class=" px-4 py-2 text-center">
                        <% currentPrice = 500 %> 
                        $<%= currentPrice %>
                    </td>
                    <td class=" px-4 py-2 text-center">
                        <% let price = stock.stockPrice - currentPrice %> 
                            <% if(price < 0) { %> 
                                <% color="red" %>
                                <span>$<%= price.toPrecision(4) %><span class="text-red-600 text-lg">&#8595;</span></span>
                            <% } else { %> 
                                <% color="green" %>
                                <span>$<%= price.toPrecision(4) %><span class="text-green-600 text-lg">&#8593;</span></span>
                            <% } %>
                    </td>
                    <td class=" px-4 py-2 text-center">
                        <% if(stock.stockPrice > currentPrice) {            %> 
                            <% loss = stock.stockPrice - currentPrice           %> 
                            <% status = (loss/stock.stockPrice) * 100           %> 
                            <% } else if(stock.stockPrice < currentPrice) {     %> 
                            <% gain = currentPrice - stock.stockPrice           %> 
                            <% status = (gain/stock.stockPrice) * 100           %> 
                            <% }                                                %>
                        <span><%= status.toPrecision(4) %>%</span>
                    </td>
                    <td class=" px-4 py-2 text-center">
                        <%= stock.noOfStock %>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <form action="/transaction/sell/<%= stock._id%>" method="POST">
                            <button type="submit">
                                <svg class="w-6 h-6" fill="none" stroke-linecap="round"
                                    stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"
                                    stroke="green">
                                    <path
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </button>
                        </form>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
              <% } else { %>
                <p><%= StockMessage %></p>
              <% } %>
        </div>

        <!-- Transaction history -->
        <div class="mt-12">
            <div class="flex justify-between">
                <!-- heading of table -->
                <h2 class="text-lg font-bold leading-tight py-3">Transaction History</h2>
                <a href="/transaction" class="mt-3 font-bold text-tempc-400">View All <span class="font-extrabold">></span></a>
            </div>
            
            <% if(  TransactionMessage === '') { %>
            <table class="table-fixed w-full">
                <thead>
                  <tr class="bg-gray-200">
                    <th class="w-1/2 px-4 py-2 lg:text-base">Date</th>
                    <th class="w-1/5 px-4 py-2 lg:text-base">Operation</th>
                    <th class="w-1/3 px-4 py-2 lg:text-base">Amount</th>
                    <th class="w-1/4 px-4 py-2 lg:text-base">Transaction About</th>
                  </tr>
                </thead>
                <tbody>
                  <% transactions.forEach( (stock) => { %>
                    <tr class="bg-white">
                      <td class="border px-4 py-2 text-base "><%= stock.createdAt %></td>
                      <td class="border px-4 py-2 text-base">
                          <% if(stock.operation == "Debited") {%>
                            <p class="text-center text-gray-100 rounded-full bg-tempc-400"><%= stock.operation %></p>
                          <%} else {%>
                            <p class="text-center text-gray-100 rounded-full bg-tempc-500"><%= stock.operation %></p>
                          <%}%>  
                     </td>
                      <td class="border px-4 py-2 text-center text-base"><%= stock.amount %></td>
                      <td class="border px-4 py-2 text-base"><%= stock.details %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
              <% } else { %>
                <p><%= TransactionMessage %></p>
              <% } %>
        </div>
    </div>

        <!-- Footer -->
        <%- include('partials/_footer.ejs') %>
</main>

<!-- script for search bar -->

<script>
    const inputField = document.getElementById('searchbar')
    inputField.addEventListener('input', (event) => {
        console.log(event.target.value)
        const value = event.target.value
        //sample data
        const dataset = <%- JSON.stringify(totalData) %> ;

        // when symbol matches

        let data = dataset.filter(function (el) {
            return el.Symbol.includes(value.toUpperCase())
        })

        // when no symbol matches

        if (data.length === 0) {

            let data1 = dataset.filter(function (el) {
                return (el["Company Name"].toLowerCase().includes(value.toLowerCase()))
            })
            data = data1;
        }

        let list = "";
        if (value === "") {
            list = "";
            data = [];
        }
        let n = data.length
        for (i = 0; i <= (n - 1); i++) {
            let item = data[i];
            list += `<li><a href='/view/${item.Symbol}'>${item.Symbol}</a></li>`
        }
        document.getElementById('search-result').innerHTML = list;
        console.log(data)
    })
</script>